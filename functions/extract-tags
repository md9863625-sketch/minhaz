export async function onRequest(context) {
    const WORKER_BASE = "https://api-server.youtubetools.xyz";

    // Only allow POST requests
    if (context.request.method !== "POST") {
        return new Response(JSON.stringify({ error: "Method not allowed" }), { 
            status: 405, 
            headers: { "Content-Type": "application/json" } 
        });
    }

    try {
        // 1. Parse input from Front-end
        const { videoId } = await context.request.json();

        if (!videoId) {
            return new Response(JSON.stringify({ error: "Video ID is required" }), { 
                status: 400, 
                headers: { "Content-Type": "application/json" } 
            });
        }

        // 2. Fetch data from the internal API
        const endpoint = `${WORKER_BASE}/videos?id=${encodeURIComponent(videoId)}`;
        const res = await fetch(endpoint);

        if (!res.ok) {
            throw new Error('External API reached with error');
        }

        const json = await res.json();

        if (!json.items || !json.items.length) {
            return new Response(JSON.stringify({ error: "Video not found" }), { 
                status: 404, 
                headers: { "Content-Type": "application/json" } 
            });
        }

        // 3. Return the tags to the front-end
        const tags = json.items[0].snippet.tags || [];
        
        return new Response(JSON.stringify({ tags }), {
            headers: { "Content-Type": "application/json" }
        });

    } catch (err) {
        return new Response(JSON.stringify({ error: err.message }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
        });
    }
}
